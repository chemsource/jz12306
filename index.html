<!DOCTYPE html>
<html lang="zh-CN" style="background-image: none !important;">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>æ±Ÿå·é“è·¯12306æŠ¥é”€å‡­è¯ç”Ÿæˆå¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0066cc',
                        secondary: '#4CAF50',
                        danger: '#f44336',
                        neutral: '#f0f0f0',
                        'neutral-dark': '#333333',
                    },
                    fontFamily: {
                        sans: ['Microsoft YaHei', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* ä¿æŒåŸå§‹è½¦ç¥¨æ ·å¼ä¸å˜ */
        .ticket {
            display: none;
            position: relative;
            width: 450px;
            height: 250px;
            margin: 20px auto;
            background: #97BDCF;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .ticket .bg-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            -webkit-mask-image: linear-gradient(to right,
                rgba(0,0,0,0) 0%,
                rgba(0,0,0,0.4) 80%,
                rgba(0,0,0,0.7) 100%
            );
            mask-image: linear-gradient(to right,
                rgba(0,0,0,0) 0%,
                rgba(0,0,0,0.4) 80%,
                rgba(0,0,0,0.7) 100%
            );
        }
        .ticket-header, .ticket-footer {
            position: absolute;
            left: 0;
            width: 100%;
            display: flex;
            align-items: center;
            padding: 0 15px;
            box-sizing: border-box;
        }
        .ticket-header {
            background: #97BDCF;
            color: black;
            height: 40px;
        }
        .ticket-footer {
            color: white;
            background: #4686A0;
            height: 25px;
        }
        .ticket-header {
            top: 0;
            justify-content: space-between;
        }
        .ticket-footer {
            bottom: 0;
            justify-content: center;
            font-size: 14px;
        }
        .ticket-content {
            position: relative;
            z-index: 1;
            height: 100%;
            padding: 35px 15px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .route {
            font-size: 28px;
            font-weight: bold;
            margin: 1px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            width: 100%;
        }
        .route::before {
            content: attr(data-start);
            margin-right: 20px;
        }
        .route::after {
            content: attr(data-end);
            margin-left: 20px;
        }
        .route span {
            font-size: 40px;
        }
        .ticket-details {
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        .time {
            text-align: left;
            font-family: "Times New Roman", Times, serif;
            font-size: 18px;
            padding-left: 2rem;
            color: #333;
            margin-bottom: 10px;
        }
        .passenger-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.15rem;
            margin: 0;
            padding: 0;
            width: 100%;
        }
        .player-info,
        .shift-info,
        .price-info {
            text-align: left;
            font-weight: bold;
            font-family: "Times New Roman", Times, serif;
            font-size: 16px;
            color: #333;
            margin: 0;
            padding: 0;
            padding-left: 2rem;
        }
        .ticket-id-container {
            display: flex;
            flex-direction: column;
            text-align: right;
        }
        .ticket-number {
            font-weight: bold;
            font-size: 14px;
        }
        .passenger-id {
            font-size: 12px;
            margin-top: 2px;
        }
    </style>
</head>
<body class="bg-neutral font-sans min-h-screen flex flex-col">
    <div class="container mx-auto px-4 py-6 flex-grow">
        <header class="text-center mb-8 flex flex-col items-center gap-2">
            <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-primary mb-2">
                <i class="fa fa-train mr-2"></i>æ±Ÿå·é“è·¯12306æŠ¥é”€å‡­è¯ç”Ÿæˆå¹³å°
            </h1>
            <p class="text-lg">æŸ¥è¯¢å¯æŠ¥é”€çš„ç­æ¬¡</p><br/>
            æ¬¢è¿å…³æ³¨Bç«™ï¼š
            <p class="flex flex-row gap-3 mx-auto text-gray-500">
                æ±Ÿå·å¸‚å¸‚é•¿ï¼š@star201
                <a href="https://space.bilibili.com/2103599412" class="text-blue-500 hover:underline flex flex-row">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-6m-7 1l9-9m-5 0h5v5"></path></svg>
                </a>
                æ±Ÿå·é“è·¯å±€å±€é•¿ï¼š@æç“¦ç‰¹å·¥è‰º-è¾“å…¥å–ï¼›
                <a href="https://space.bilibili.com/1643658754" class="text-blue-500 hover:underline flex flex-row">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-6m-7 1l9-9m-5 0h5v5"></path></svg>
                </a>
                æ±Ÿå·è·¯æ¡¥/æ±Ÿå·äº¤å»ºï¼š@ChemsourceåŒ–æºå·¥ä½œå®¤
                <a href="https://space.bilibili.com/543796790" class="text-blue-500 hover:underline flex flex-row">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-6m-7 1l9-9m-5 0h5v5"></path></svg>
                </a>
                æ±Ÿå·ç¬¬ä¸€å»ºç­‘å±€å±€é•¿ï¼š@å°ä½³å“¥é¸­
                <a href="https://space.bilibili.com/560157590" class="text-blue-500 hover:underline flex flex-row">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-6m-7 1l9-9m-5 0h5v5"></path></svg>
                </a>
            </p>
        </header>
        
        <!-- éŸ³ä¹æ§åˆ¶åŒº -->
        <div class="music-control fixed top-4 right-4 bg-white/80 backdrop-blur-sm rounded-full px-4 py-2 shadow-lg flex items-center z-50">
            <button id="musicBtn" class="music-btn-hover bg-primary text-white px-3 py-1 rounded-full text-sm flex items-center">
                <i class="fa fa-music mr-1"></i> <span id="musicBtnText">å¼€å¯éŸ³ä¹</span>
            </button>
            <div id="musicStatus" class="w-3 h-3 rounded-full bg-gray-300 mx-2"></div>
            <div class="volume-control flex items-center">
                <span class="volume-icon text-gray-600">ğŸ”Š</span>
                <input type="range" min="0" max="1" step="0.1" value="0.5" class="volume-slider" id="volumeSlider">
            </div>
        </div>
        <div id="musicError" class="text-red-500 mt-2 text-sm hidden"></div>
        
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mt-12">
            <!-- å·¦ä¾§è¡¨å•åŒºåŸŸ -->
            <div class="lg:col-span-5 bg-white rounded-xl p-6 form-shadow">
                <h2 class="text-xl font-bold text-primary mb-6 flex items-center">
                    <i class="fa fa-train mr-2"></i> è½¦ç¥¨ä¿¡æ¯
                </h2>
                
                <form class="space-y-4">
                    <div class="space-y-2">
                        <label for="start" class="block text-sm font-medium text-gray-700">èµ·ç‚¹ï¼š</label>
                        <select id="start" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                            <option value="æ±Ÿå·è¥¿ç«™">æ±Ÿå·è¥¿ç«™</option>
                            <option value="å¸‚éƒŠæ±Ÿå·è¥¿ç«™">å¸‚éƒŠæ±Ÿå·è¥¿ç«™</option>
                            <option value="è¥¿åŒºä¸€çŸ¿">è¥¿åŒºä¸€çŸ¿</option>
                            <option value="é²¸å²›ä¸œç«™">é²¸å²›ä¸œç«™</option>
                            <option value="æ±ŸåŒ—ç«™">æ±ŸåŒ—ç«™</option>
                            <option value="æ±Ÿå·å—ç«™">æ±Ÿå·å—ç«™</option>
                        </select>
                        <div id="start-info" class="text-xs text-gray-500 mt-1">æ±Ÿå·å¸‚ç›®å‰æœ€å¤§çš„é“è·¯äº¤é€šæ¢çº½</div>
                    </div>
                    
                    <div class="space-y-2">
                        <label for="end" class="block text-sm font-medium text-gray-700">ç»ˆç‚¹ï¼š</label>
                        <select id="end" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                            <option value="æ±Ÿå·è¥¿ç«™">æ±Ÿå·è¥¿ç«™</option>
                            <option value="å¸‚éƒŠæ±Ÿå·è¥¿ç«™">å¸‚éƒŠæ±Ÿå·è¥¿ç«™</option>
                            <option value="è¥¿åŒºä¸€çŸ¿">è¥¿åŒºä¸€çŸ¿</option>
                            <option value="é²¸å²›ä¸œç«™">é²¸å²›ä¸œç«™</option>
                            <option value="æ±ŸåŒ—ç«™">æ±ŸåŒ—ç«™</option>
                            <option value="æ±Ÿå·å—ç«™">æ±Ÿå·å—ç«™</option>
                        </select>
                        <div id="end-info" class="text-xs text-gray-500 mt-1">æ±Ÿå·é“è·¯ç¼–ç»„ç«™</div>
                    </div>
                    
                    <div id="price-preview" class="text-sm text-gray-700 font-medium">é¢„è®¡ç¥¨ä»·: 13.72 ç»¿å®çŸ³</div>
                    
                    <div class="space-y-2">
                        <label for="playerName" class="block text-sm font-medium text-gray-700">æ¸¸æˆåç§°ï¼š</label>
                        <input type="text" id="playerName" placeholder="è¾“å…¥ä½ çš„æ¸¸æˆåç§°" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                    </div>
                    
                    <div class="space-y-2">
                        <label for="departureDate" class="block text-sm font-medium text-gray-700">å‡ºå‘æ—¥æœŸï¼š</label>
                        <input type="date" id="departureDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                        <div id="date-info" class="text-xs text-gray-500 mt-1">å¯é€‰æ‹©ä»Šå¤©åŠæœªæ¥2å¤©çš„æ—¥æœŸ</div>
                    </div>
                    
                    <div class="space-y-2">
                        <label for="shift" class="block text-sm font-medium text-gray-700">ç­æ¬¡ï¼š</label>
                        <select id="shift" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                            <!-- ç­æ¬¡é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </select>
                        <div id="shift-info" class="text-xs text-gray-500 mt-1">è¯·å…ˆé€‰æ‹©èµ·ç‚¹ã€ç»ˆç‚¹å’Œæ—¥æœŸ</div>
                    </div>
                    <div id="form-error-msg" class="space-y-2">
                    </div>
                    <div class="flex flex-wrap gap-3 pt-2">
                        <button type="button" onclick="validateAndGenerate()" class="btn-hover bg-secondary text-white px-6 py-2 rounded-lg font-medium flex items-center">
                            <i class="fa fa-ticket mr-2"></i> è´­ä¹°è½¦ç¥¨
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- å³ä¾§è½¦ç¥¨å’Œå†å²è®°å½•åŒºåŸŸ -->
            <div class="lg:col-span-7 space-y-8">
                <!-- è½¦ç¥¨æ˜¾ç¤ºåŒºåŸŸ -->
                <div class="bg-white rounded-xl p-6 form-shadow">
                    <h2 class="text-xl font-bold text-primary mb-6 flex items-center">
                        <i class="fa fa-print mr-2"></i> å·²è´­è½¦ç¥¨
                    </h2>
                    
                    <div class="ticket-container flex justify-center">
                        <!-- åŸå§‹è½¦ç¥¨æ ·å¼ä¿æŒä¸å˜ -->
                        <div class="ticket" id="ticket">
                            <img src="https://ticket.codeart.online/" alt="èƒŒæ™¯å›¾" class="bg-img">
                            <div class="ticket-header">
                                <div class="station-name">æ±Ÿå·é“è·¯è½¦ç¥¨</div>
                                <div class="ticket-id-container">
                                    <div class="ticket-number" id="ticketNumber">TID: 12345678</div>
                                    <div class="passenger-id" id="passengerId">PID: ABCDEFGH</div>
                                </div>
                            </div>
                            <div class="ticket-content">
                                <div class="route" id="route" data-start="" data-end="">
                                    <span>â†’</span>
                                </div>
                                <div class="ticket-details">
                                    <div class="time" id="time"></div>
                                    <div class="passenger-info">
                                        <div class="player-info">
                                            <div>ç©å®¶ï¼š<span id="playerNameDisplay"></span></div>
                                        </div>
                                        <div class="shift-info">
                                            <div>ç­æ¬¡ï¼š<span id="shiftDisplay"></span></div>
                                        </div>
                                        <div class="price-info">
                                            <div>å”®ä»·ï¼š<span id="priceDisplay"></span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="ticket-footer">
                                <div>æ¬¢è¿ä¹˜åæ±Ÿå·é“è·¯</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å†å²è®°å½•åŒºåŸŸ -->
                <div class="bg-white rounded-xl p-6 form-shadow overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-primary flex items-center">
                            <i class="fa fa-history mr-2"></i> è´­ä¹°è®°å½•
                        </h2>
                    </div>
                    
                    <div class="overflow-x-auto h-[350px]" id="historyTable">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs uppercase bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 rounded-tl-lg">èµ·ç‚¹</th>
                                    <th class="px-4 py-3">ç»ˆç‚¹</th>
                                    <th class="px-4 py-3">ç©å®¶åç§°</th>
                                    <th class="px-4 py-3">ç­æ¬¡</th>
                                    <th class="px-4 py-3">å‡ºå‘æ—¶é—´</th>
                                    <th class="px-4 py-3">ç¥¨ä»·</th>
                                    <th class="px-4 py-3">æ—¶é—´</th>
                                    <th class="px-4 py-3 rounded-tr-lg">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody" class="divide-y divide-gray-200">
                                <!-- å†å²è®°å½•å°†é€šè¿‡JSå¡«å…… -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ³¨æ„äº‹é¡¹ -->
        <div class="mt-12 bg-white rounded-xl p-6 form-shadow">
            <h2 class="text-xl font-bold text-primary mb-4 flex items-center">
                <i class="fa fa-info-circle mr-2"></i> æ³¨æ„äº‹é¡¹
            </h2>
            <ul class="list-disc pl-5 space-y-2 text-gray-700">
                <li>æœ¬è½¦ç¥¨ä»…ä¾›æŸ¥è¯¢ï¼Œå®é™…è¯·å‰å¾€æœåŠ¡å™¨è´­ä¹°ã€‚</li>
                <li>æ‰€æœ‰æ•°æ®å‡åœ¨æœ¬åœ°ç”Ÿæˆï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚</li>
                <li>èƒŒæ™¯éŸ³ä¹å¯ä»¥é€šè¿‡å³ä¸Šè§’çš„éŸ³ä¹æ§åˆ¶å™¨è¿›è¡Œå¼€å…³å’ŒéŸ³é‡è°ƒèŠ‚ã€‚</li>
                <li>ä½¿ç”¨æ¬¡æ•°æ— é™åˆ¶ï¼Œå†å²è®°å½•ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­ã€‚</li>
                <li>ç­æ¬¡é€‰æ‹©å·²æ ¹æ®å®é™…è·¯çº¿è¿›è¡Œé™åˆ¶ï¼Œåªèƒ½é€‰æ‹©ç¬¦åˆæ¡ä»¶çš„ç­æ¬¡ã€‚</li>
                <li>å¯ä»¥é€‰æ‹©å½“å¤©è¿˜æœªå‘è½¦çš„ç­æ¬¡ä»¥åŠæœªæ¥2å¤©çš„ç­æ¬¡ã€‚</li>
            </ul>
        </div>
    </div>
    
    <!-- é¡µè„š -->
    <footer class="bg-primary text-white py-4 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p>Â© 2025 å…¨ç¾¤ç³»é“è·¯å®šåˆ¶è½¦ç¥¨ç”Ÿæˆå™¨ - ä¿ç•™æ‰€æœ‰æƒåˆ©</p>
            <p>åˆ¶ä½œäººå‘˜ï¼šâ¤ï¸ å°åŒ– â¤ï¸</p>
        </div>
    </footer>
    
    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio id="bgMusic" loop>
        <source src="bgm.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ================= æœ¬åœ°æ ¡éªŒç ç”Ÿæˆç®—æ³• =================
        // æ¨¡æ‹ŸMinGWçš„rand()å‡½æ•°å®ç°
        class MinGWRandom {
            constructor(seed = 1) {
                this.state = seed;
            }

            srand(seed) {
                this.state = seed;
            }

            rand() {
                // LCGå‚æ•°: multiplier = 214013, increment = 2531011
                this.state = (this.state * 214013 + 2531011) & 0xFFFFFFFF;
                return (this.state >>> 16) & 0x7FFF; // è¿”å›0~32767çš„æ•´æ•°
            }
        }

        // SRDå­—ç¬¦æ˜ å°„è¡¨
        const srdCharToDigit = {
            'A': "1", 'B': "3", 'C': "5", 'D': "7", 'E': "9",
            'F': "5", 'G': "4", 'H': "2", 'I': "8", 'J': "11",
            'K': "13", 'L': "17", 'M': "19", 'N': "10", 'O': "12",
            'P': "14", 'Q': "16", 'R': "18", 'S': "20", 'T': "22",
            'U': "24", 'V': "26", 'W': "21", 'X': "23", 'Y': "25", 'Z': "6"
        };
        
        const srdCharoToDigit = {
            '`': "9901", '~': "9902", '!': "9903", '@': "9904", '#': "9905", '$': "9906", '%': "9907",
            '^': "9908", '&': "9909", '*': "9910", '(': "9911", ')': "9912", '-': "9913", '_': "9914",
            '+': "9915", '=': "9916", '[': "9917", ']': "9918", '{': "9919", '}': "9920", '\\': "9921",
            '|': "9922", ':': "9923", ';': "9924", '"': "9925", "'": "9926", ',': "9927", '.' : "9928",
            '<': "9929", '>': "9930", '/': "9931", '?': "9932"
        };

        // CSRDLCå­—ç¬¦æ˜ å°„è¡¨
        const charToDigit = {
            'A': "9801", 'B': "9802", 'C': "9803", 'D': "9804", 'E': "9805",
            'F': "9806", 'G': "9807", 'H': "9808", 'I': "9809", 'J': "9810",
            'K': "9811", 'L': "9812", 'M': "9813", 'N': "9814", 'O': "9815",
            'P': "9816", 'Q': "9817", 'R': "9818", 'S': "9819", 'T': "9820",
            'U': "9821", 'V': "9822", 'W': "9823", 'X': "9824", 'Y': "9825", 'Z': "9826"
        };
        
        const lToDigit = {
            'a': "9701", 'b': "9702", 'c': "9703", 'd': "9704", 'e': "9705",
            'f': "9706", 'g': "9707", 'h': "9708", 'i': "9709", 'j': "9710",
            'k': "9711", 'l': "9712", 'm': "9713", 'n': "9714", 'o': "9715",
            'p': "9716", 'q': "9717", 'r': "9718", 's': "9719", 't': "9720",
            'u': "9721", 'v': "9722", 'w': "9723", 'x': "9724", 'y': "9725", 'z': "9726"
        };
        
        const charoToDigit = {
            '`': "9901", '~': "9902", '!': "9903", '@': "9904", '#': "9905", '$': "9906", '%': "9907",
            '^': "9908", '&': "9909", '*': "9910", '(': "9911", ')': "9912", '-': "9913", '_': "9914",
            '+': "9915", '=': "9916", '[': "9917", ']': "9918", '{': "9919", '}': "9920", '\\': "9921",
            '|': "9922", ':': "9923", ';': "9924", '"': "9925", "'": "9926", ',': "9927", '.': "9928",
            '<': "9929", '>': "9930", '/': "9931", '?': "9932",
            'Â·': "8901", 'ï¼': "8902", 'ï¿¥': "8903", 'â€¦': "8904", 'ï¼ˆ': "8905", 'ï¼‰': "8906", 'â€”': "8907",
            'ã€': "8908", 'ã€‘': "8909", 'ã€': "8910", 'ï¼š': "8911", 'ï¼›': "8912", 'â€œ': "8913", 'â€': "8914",
            'â€˜': "8915", 'â€™': "8916", 'ã€Š': "8917", 'ã€‹': "8918", 'ï¼Ÿ': "8919"
        };

        // ç”ŸæˆSRDæ ¡éªŒç 
        function generateSRD(input) {
            let digitStr = "";
            let modValue = 0;
            const MOD_BASE = 0x3FFFFFFF; // 1073741823

            for (let c of input) {
                if (/[A-Za-z]/.test(c)) {
                    const upperChar = c.toUpperCase();
                    if (srdCharToDigit[upperChar]) {
                        const numStr = srdCharToDigit[upperChar];
                        digitStr += numStr;
                        for (let digit of numStr) {
                            modValue = (modValue * 10 + parseInt(digit)) % MOD_BASE;
                        }
                    }
                } else if (/[0-9]/.test(c)) {
                    digitStr += c;
                    modValue = (modValue * 10 + parseInt(c)) % MOD_BASE;
                } else {
                    if (srdCharoToDigit[c]) {
                        const numStr = srdCharoToDigit[c];
                        digitStr += numStr;
                        for (let digit of numStr) {
                            modValue = (modValue * 10 + parseInt(digit)) % MOD_BASE;
                        }
                    }
                }
            }

            let lastSixDigits = 0;
            if (digitStr.length > 0) {
                const startIndex = Math.max(0, digitStr.length - 6);
                const lastSixStr = digitStr.substring(startIndex);
                lastSixDigits = parseInt(lastSixStr) || 1000000;
            } else {
                lastSixDigits = 1000000;
            }

            const prng = new MinGWRandom(modValue);
            
            let randTimes;
            if (input.length <= 5) randTimes = 2;
            else if (input.length <= 10) randTimes = 3;
            else if (input.length <= 15) randTimes = 4;
            else if (input.length <= 20) randTimes = 5;
            else randTimes = 6;

            let result = "";
            for (let i = 0; i < randTimes; i++) {
                const randNum = prng.rand();
                const modResult = randNum % lastSixDigits;
                result += modResult.toString();
            }

            // è¿”å›å‰8ä½å­—ç¬¦
            return result.substring(0, 8);
        }

        // ç”ŸæˆCSRDLCæ ¡éªŒç 
        function generateCSRDLC(input) {
            let digitStr = "";
            let modValue = 0;
            const MOD_BASE = 0x3FFFFFFF; // 1073741823

            for (let c of input) {
                if (/[A-Z]/.test(c)) {
                    if (charToDigit[c]) {
                        const numStr = charToDigit[c];
                        digitStr += numStr;
                        for (let digit of numStr) {
                            modValue = (modValue * 10 + parseInt(digit)) % MOD_BASE;
                        }
                    }
                } else if (/[a-z]/.test(c)) {
                    if (lToDigit[c]) {
                        const numStr = lToDigit[c];
                        digitStr += numStr;
                        for (let digit of numStr) {
                            modValue = (modValue * 10 + parseInt(digit)) % MOD_BASE;
                        }
                    }
                } else if (/[0-9]/.test(c)) {
                    digitStr += c;
                    modValue = (modValue * 10 + parseInt(c)) % MOD_BASE;
                } else {
                    if (charoToDigit[c]) {
                        const numStr = charoToDigit[c];
                        digitStr += numStr;
                        for (let digit of numStr) {
                            modValue = (modValue * 10 + parseInt(digit)) % MOD_BASE;
                        }
                    }
                }
            }

            let lastSixDigits = 0;
            if (digitStr.length > 0) {
                const startIndex = Math.max(0, digitStr.length - 6);
                const lastSixStr = digitStr.substring(startIndex);
                lastSixDigits = parseInt(lastSixStr) || 1000000;
            } else {
                lastSixDigits = 1000000;
            }

            const prng = new MinGWRandom(modValue);
            
            let randTimes;
            if (input.length <= 5) randTimes = 2;
            else if (input.length <= 10) randTimes = 3;
            else if (input.length <= 15) randTimes = 4;
            else if (input.length <= 20) randTimes = 5;
            else randTimes = 6;

            let result = "";
            for (let i = 0; i < randTimes; i++) {
                const randNum = prng.rand();
                const modResult = randNum % lastSixDigits;
                result += modResult.toString();
            }

            // è¿”å›å‰8ä½å­—ç¬¦
            return result.substring(0, 8);
        }
        
        // ================= è½¦ç¥¨ç”Ÿæˆæ ¸å¿ƒé€»è¾‘ =================
        // ç«™å°è·ç¦»æƒé‡ï¼ˆç”¨äºè®¡ç®—ç¥¨ä»·ï¼‰
        const stationWeights = {
            "æ±Ÿå·è¥¿ç«™": 0,
            "å¸‚éƒŠæ±Ÿå·è¥¿ç«™": 0,
            "è¥¿åŒºä¸€çŸ¿": 30,
            "é²¸å²›ä¸œç«™": 65,
            "æ±ŸåŒ—ç«™": 107,
            "æ±Ÿå·å—ç«™": 258,
        };
        // è½¦ç«™æè¿°ä¿¡æ¯
        const stationDescriptions = {
            "æ±Ÿå·è¥¿ç«™": "æ±Ÿå·ç¬¬ä¸€åº§é“è·¯è½¦ç«™ï¼Œæ‰¿æ‹…ç€å¸‚éƒŠé“è·¯ä¸å›½é“çš„æ¢çº½ä½œç”¨",
            "å¸‚éƒŠæ±Ÿå·è¥¿ç«™": "æ±Ÿå·å¸‚éƒŠé“è·¯çš„ç»¼åˆæ¢çº½",
            "è¥¿åŒºä¸€çŸ¿": "æ±Ÿå·è¥¿åŸçŸ¿åŒºçš„ä¹˜é™æ‰€ï¼Œå·¥äººä»¬é€šå‹¤çš„å¿…ç»ä¹‹ç«™",
            "é²¸å²›ä¸œç«™": "æ±Ÿå·é¦–ä¸ªé‡‡ç”¨åœ°ä¸‹å»ºç­‘çš„ç«™ç‚¹",
            "æ±ŸåŒ—ç«™": "ä»¥ç°å®ä¸­çš„ä¸€ä¸ªä¸‰çº§ç«™ä¸ºåŸå‹ï¼Œæ±Ÿå·é“è·¯ç»¼åˆç¼–ç»„å’Œè´§è¿ç«™",
            "æ±Ÿå·å—ç«™": "æ±Ÿå·ç›®å‰æœ€å¤§çš„é“è·¯æ¢çº½"
        };

        // è½¦æ¬¡è·¯çº¿ä¿¡æ¯
        const trainRoutes = {
            "C2005": ["é²¸å²›ä¸œç«™", "æ±Ÿå·è¥¿ç«™", "æ±Ÿå·å—ç«™"],
            "C2008": ["æ±Ÿå·å—ç«™", "æ±Ÿå·è¥¿ç«™", "é²¸å²›ä¸œç«™"],
            "C2007": ["æ±ŸåŒ—ç«™", "é²¸å²›ä¸œç«™", "æ±Ÿå·è¥¿ç«™"],
            "C2010": ["æ±Ÿå·è¥¿ç«™", "é²¸å²›ä¸œç«™", "æ±ŸåŒ—ç«™"],
            "C2012": ["æ±ŸåŒ—ç«™", "é²¸å²›ä¸œç«™", "æ±Ÿå·å—ç«™"],
            "C2013": ["æ±Ÿå·å—ç«™", "é²¸å²›ä¸œç«™", "æ±ŸåŒ—ç«™"],
            "C2312": ["æ±ŸåŒ—ç«™", "æ±Ÿå·è¥¿ç«™", "æ±Ÿå·å—ç«™"],
            "C2315": ["æ±Ÿå·å—ç«™", "æ±Ÿå·è¥¿ç«™", "æ±ŸåŒ—ç«™"],
            "C2000": ["æ±Ÿå·å—ç«™", "æ±ŸåŒ—ç«™"],
            "C2001": ["æ±ŸåŒ—ç«™", "æ±Ÿå·å—ç«™"],
            "S201": ["å¸‚éƒŠæ±Ÿå·è¥¿ç«™", "è¥¿åŒºä¸€çŸ¿"],
            "S202": ["è¥¿åŒºä¸€çŸ¿", "å¸‚éƒŠæ±Ÿå·è¥¿ç«™"]
        };

        // è½¦æ¬¡æ—¶åˆ»è¡¨é…ç½®
        const trainSchedules = {
            "C2005": { startTime: "08:00", interval: 60, count: 12 }, // 8:00å¼€å§‹ï¼Œæ¯å°æ—¶ä¸€ç­ï¼Œå…±12ç­
            "C2008": { startTime: "08:00", interval: 60, count: 12 },
            "C2012": { startTime: "08:15", interval: 60, count: 12 },
            "C2013": { startTime: "08:15", interval: 60, count: 12 },
            "C2312": { startTime: "08:30", interval: 60, count: 12 },
            "C2315": { startTime: "08:30", interval: 60, count: 12 },
            "C2000": { startTime: "08:45", interval: 60, count: 12 },
            "C2001": { startTime: "08:45", interval: 60, count: 12 },
            "C2007": { startTime: "09:00", interval: 60, count: 12 }, // è¡¥å……C2007å’ŒC2010çš„æ—¶åˆ»è¡¨
            "C2010": { startTime: "09:00", interval: 60, count: 12 },
            "S201": { startTime: "06:00", interval: 30, count: 24 }, // å¸‚éƒŠé“è·¯ç­æ¬¡æ›´é¢‘ç¹
            "S202": { startTime: "06:00", interval: 30, count: 24 }
        };

        // æ ¹æ®èµ·ç‚¹å’Œç»ˆç‚¹è·å–å¯ç”¨çš„ç­æ¬¡
        function getAvailableShifts(start, end, selectedDate) {
            const availableShifts = [];
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const selectedDateObj = new Date(selectedDate);
            const isToday = selectedDateObj.getTime() === today.getTime();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // éå†æ‰€æœ‰è½¦æ¬¡
            for (const [shift, route] of Object.entries(trainRoutes)) {
                const startIndex = route.indexOf(start);
                const endIndex = route.indexOf(end);
                
                // æ£€æŸ¥èµ·ç‚¹å’Œç»ˆç‚¹æ˜¯å¦éƒ½åœ¨è¯¥è½¦æ¬¡çš„è·¯çº¿ä¸Šï¼Œå¹¶ä¸”èµ·ç‚¹åœ¨ç»ˆç‚¹ä¹‹å‰
                if (startIndex !== -1 && endIndex !== -1 && startIndex < endIndex) {
                    // è·å–è¯¥è½¦æ¬¡çš„æ—¶åˆ»è¡¨
                    const schedule = trainSchedules[shift];
                    if (schedule) {
                        const startTime = schedule.startTime.split(":");
                        const startHour = parseInt(startTime[0]);
                        const startMinute = parseInt(startTime[1]);
                        
                        // ç”Ÿæˆè¯¥è½¦æ¬¡çš„æ‰€æœ‰ç­æ¬¡æ—¶é—´
                        for (let i = 0; i < schedule.count; i++) {
                            const hour = startHour + Math.floor((startMinute + i * schedule.interval) / 60);
                            const minute = (startMinute + i * schedule.interval) % 60;
                            const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                            
                            // å¦‚æœæ˜¯ä»Šå¤©ï¼Œåªæ˜¾ç¤ºè¿˜æœªå‘è½¦çš„ç­æ¬¡
                            if (isToday) {
                                if (hour > currentHour || (hour === currentHour && minute > currentMinute)) {
                                    availableShifts.push({
                                        shift: shift,
                                        time: timeStr,
                                        displayText: `${shift} (${timeStr})`
                                    });
                                }
                            } else {
                                // å¦‚æœæ˜¯æœªæ¥æ—¥æœŸï¼Œæ˜¾ç¤ºæ‰€æœ‰ç­æ¬¡
                                availableShifts.push({
                                    shift: shift,
                                    time: timeStr,
                                    displayText: `${shift} (${timeStr})`
                                });
                            }
                        }
                    }
                }
            }
            
            // æŒ‰æ—¶é—´æ’åº
            availableShifts.sort((a, b) => {
                const timeA = a.time.split(":");
                const timeB = b.time.split(":");
                const hourA = parseInt(timeA[0]);
                const minuteA = parseInt(timeA[1]);
                const hourB = parseInt(timeB[0]);
                const minuteB = parseInt(timeB[1]);
                
                if (hourA !== hourB) {
                    return hourA - hourB;
                }
                return minuteA - minuteB;
            });
            
            return availableShifts;
        }

        // æ›´æ–°ç­æ¬¡ä¸‹æ‹‰èœå•
        function updateShiftOptions() {
            const startStation = document.getElementById('start').value;
            const endStation = document.getElementById('end').value;
            const departureDate = document.getElementById('departureDate').value;
            const shiftSelect = document.getElementById('shift');
            const shiftInfo = document.getElementById('shift-info');
            
            // æ¸…ç©ºå½“å‰é€‰é¡¹
            shiftSelect.innerHTML = '';
            
            // æ£€æŸ¥å¿…è¦ä¿¡æ¯
            if (!departureDate) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'è¯·å…ˆé€‰æ‹©å‡ºå‘æ—¥æœŸ';
                shiftSelect.appendChild(option);
                shiftSelect.disabled = true;
                shiftInfo.textContent = 'è¯·é€‰æ‹©å‡ºå‘æ—¥æœŸ';
                return;
            }
            
            // å¦‚æœèµ·ç‚¹ç»ˆç‚¹ç›¸åŒï¼Œæ˜¾ç¤ºæç¤º
            if (startStation === endStation) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'è¯·é€‰æ‹©ä¸åŒçš„èµ·ç‚¹å’Œç»ˆç‚¹';
                shiftSelect.appendChild(option);
                shiftSelect.disabled = true;
                shiftInfo.textContent = 'èµ·ç‚¹å’Œç»ˆç‚¹ä¸èƒ½ç›¸åŒ';
                return;
            }
            
            // è·å–å¯ç”¨çš„ç­æ¬¡
            const availableShifts = getAvailableShifts(startStation, endStation, departureDate);
            
            if (availableShifts.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ç­æ¬¡';
                shiftSelect.appendChild(option);
                shiftSelect.disabled = true;
                shiftInfo.textContent = 'å½“å‰èµ·ç‚¹å’Œç»ˆç‚¹ä¹‹é—´æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ç­æ¬¡';
            } else {
                shiftSelect.disabled = false;
                
                // æ·»åŠ é»˜è®¤æç¤ºé€‰é¡¹
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'è¯·é€‰æ‹©ç­æ¬¡';
                shiftSelect.appendChild(defaultOption);
                
                // æ·»åŠ å¯ç”¨ç­æ¬¡
                availableShifts.forEach(shiftInfo => {
                    const option = document.createElement('option');
                    option.value = `${shiftInfo.shift}|${shiftInfo.time}`;
                    option.textContent = shiftInfo.displayText;
                    shiftSelect.appendChild(option);
                });
                
                shiftInfo.textContent = `å…±æ‰¾åˆ° ${availableShifts.length} ä¸ªç¬¦åˆæ¡ä»¶çš„ç­æ¬¡`;
            }
        }

        // éŸ³ä¹æ§åˆ¶
        const bgMusic = document.getElementById('bgMusic');
        const musicBtn = document.getElementById('musicBtn');
        const musicBtnText = document.getElementById('musicBtnText');
        const musicStatus = document.getElementById('musicStatus');
        const musicError = document.getElementById('musicError');
        const volumeSlider = document.getElementById('volumeSlider');
        let isPlaying = false;
        let userInteracted = false;
        
        // åˆå§‹åŒ–éŸ³ä¹çŠ¶æ€å’ŒéŸ³é‡
        const musicState = localStorage.getItem('musicState');
        const savedVolume = localStorage.getItem('musicVolume');
        if (savedVolume !== null) {
            bgMusic.volume = parseFloat(savedVolume);
            volumeSlider.value = bgMusic.volume;
        } else {
            // é»˜è®¤éŸ³é‡ä¸º50%
            bgMusic.volume = 0.5;
            volumeSlider.value = 0.5;
        }
        
        if (musicState === 'playing') {
            musicBtnText.textContent = "å…³é—­éŸ³ä¹";
            // å°è¯•åœ¨é¡µé¢åŠ è½½åè‡ªåŠ¨æ’­æ”¾ï¼ˆéœ€è¦ç”¨æˆ·äº¤äº’ï¼‰
            attemptAutoPlayAfterInteraction();
        }
        
        // ç»‘å®šéŸ³ä¹æ§åˆ¶äº‹ä»¶
        musicBtn.addEventListener('click', toggleMusic);
        volumeSlider.addEventListener('input', adjustVolume);
        
        // é¡µé¢é¦–æ¬¡äº¤äº’åå°è¯•è‡ªåŠ¨æ’­æ”¾éŸ³ä¹
        function attemptAutoPlayAfterInteraction() {
            if (!userInteracted) {
                // ç­‰å¾…ç”¨æˆ·é¦–æ¬¡ç‚¹å‡»
                document.addEventListener('click', function startMusicAfterFirstInteraction() {
                    userInteracted = true;
                    if (musicState === 'playing' && !isPlaying) {
                        playMusic().catch(e => {
                            console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œéœ€ç”¨æˆ·æ‰‹åŠ¨å¼€å¯', e);
                        });
                    }
                    // åªéœ€è¦æ‰§è¡Œä¸€æ¬¡
                    document.removeEventListener('click', startMusicAfterFirstInteraction);
                }, { once: true });
            }
        }
        
        // æ’­æ”¾éŸ³ä¹å‡½æ•°
        async function playMusic() {
            try {
                // å¦‚æœéŸ³é¢‘å·²ç»æš‚åœæˆ–åœæ­¢ï¼Œåˆ™éœ€è¦é‡æ–°åŠ è½½
                if (bgMusic.paused || bgMusic.ended) {
                    bgMusic.load();
                }
                
                await bgMusic.play();
                isPlaying = true;
                musicBtnText.textContent = "å…³é—­éŸ³ä¹";
                musicStatus.classList.add('bg-green-500');
                musicStatus.classList.remove('bg-gray-300');
                musicError.style.display = 'none';
                localStorage.setItem('musicState', 'playing');
            } catch (e) {
                console.error('éŸ³ä¹æ’­æ”¾å¤±è´¥:', e);
                isPlaying = false;
                musicBtnText.textContent = "å¼€å¯éŸ³ä¹";
                musicStatus.classList.remove('bg-green-500');
                musicStatus.classList.add('bg-gray-300');
                musicError.textContent = `éŸ³ä¹æ’­æ”¾å¤±è´¥: ${e.message}ã€‚è¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®æˆ–å°è¯•åˆ·æ–°é¡µé¢ã€‚`;
                musicError.style.display = 'block';
                localStorage.setItem('musicState', 'paused');
            }
        }
        
        // åˆ‡æ¢éŸ³ä¹æ’­æ”¾çŠ¶æ€
        function toggleMusic() {
            // ç¡®ä¿ç”¨æˆ·å·²ç»æœ‰è¿‡äº¤äº’
            if (!userInteracted) {
                userInteracted = true;
            }
            
            if (isPlaying) {
                bgMusic.pause();
                isPlaying = false;
                musicBtnText.textContent = "å¼€å¯éŸ³ä¹";
                musicStatus.classList.remove('bg-green-500');
                musicStatus.classList.add('bg-gray-300');
                localStorage.setItem('musicState', 'paused');
            } else {
                playMusic();
            }
        }
        
        // è°ƒæ•´éŸ³é‡
        function adjustVolume() {
            const volume = parseFloat(volumeSlider.value);
            bgMusic.volume = volume;
            localStorage.setItem('musicVolume', volume);
            
            // æ›´æ–°éŸ³é‡å›¾æ ‡
            const volumeIcon = document.querySelector('.volume-icon');
            if (volume > 0.7) {
                volumeIcon.textContent = 'ğŸ”Š';
            } else if (volume > 0) {
                volumeIcon.textContent = 'ğŸ”‰';
            } else {
                volumeIcon.textContent = 'ğŸ”ˆ';
            }
        }

        // éŸ³é¢‘äº‹ä»¶ç›‘å¬
        bgMusic.addEventListener('error', function() {
            console.error('éŸ³é¢‘åŠ è½½é”™è¯¯:', bgMusic.error);
            isPlaying = false;
            musicBtnText.textContent = "å¼€å¯éŸ³ä¹";
            musicStatus.classList.remove('bg-green-500');
            musicStatus.classList.add('bg-gray-300');
            musicError.textContent = `éŸ³é¢‘åŠ è½½é”™è¯¯: ${bgMusic.error.message || 'æœªçŸ¥é”™è¯¯'}`;
            musicError.style.display = 'block';
            localStorage.setItem('musicState', 'paused');
        });
        
        bgMusic.addEventListener('ended', function() {
            console.log('éŸ³é¢‘æ’­æ”¾ç»“æŸ');
            isPlaying = false;
            musicBtnText.textContent = "å¼€å¯éŸ³ä¹";
            musicStatus.classList.remove('bg-green-500');
            musicStatus.classList.add('bg-gray-300');
            localStorage.setItem('musicState', 'paused');
        });
        
        bgMusic.addEventListener('play', function() {
            console.log('éŸ³é¢‘å¼€å§‹æ’­æ”¾');
            isPlaying = true;
            musicBtnText.textContent = "å…³é—­éŸ³ä¹";
            musicStatus.classList.add('bg-green-500');
            musicStatus.classList.remove('bg-gray-300');
            musicError.style.display = 'none';
        });
        
        bgMusic.addEventListener('pause', function() {
            console.log('éŸ³é¢‘å·²æš‚åœ');
            isPlaying = false;
            musicBtnText.textContent = "å¼€å¯éŸ³ä¹";
            musicStatus.classList.remove('bg-green-500');
            musicStatus.classList.add('bg-gray-300');
        });

        // åŠ¨æ€ç¥¨ä»·è®¡ç®—æ˜¾ç¤º
        function updatePricePreview() {
            const startStation = document.getElementById('start').value;
            const endStation = document.getElementById('end').value;
            const distance = Math.abs(stationWeights[startStation] - stationWeights[endStation]);
            const price = ((distance+2) * 1.0 / 20).toFixed(2);

            const previewEl = document.getElementById('price-preview');
            previewEl.textContent = `é¢„è®¡ç¥¨ä»·: ${price} ç»¿å®çŸ³`;
            
            // åŒæ—¶æ›´æ–°ç­æ¬¡é€‰é¡¹
            updateShiftOptions();
        }

        // è½¦ç«™ä¿¡æ¯æç¤º
        function updateStationInfo() {
            const startStation = document.getElementById('start').value;
            const endStation = document.getElementById('end').value;
            const startInfoEl = document.getElementById('start-info');
            const endInfoEl = document.getElementById('end-info');
            startInfoEl.textContent = stationDescriptions[startStation];
            endInfoEl.textContent = stationDescriptions[endStation];
            
            // åŒæ—¶æ›´æ–°ç­æ¬¡é€‰é¡¹
            updateShiftOptions();
        }

        // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
        function initDatePicker() {
            const dateInput = document.getElementById('departureDate');
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dayAfterTomorrow = new Date(today);
            dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);
            
            // è®¾ç½®æœ€å°å€¼ä¸ºä»Šå¤©
            dateInput.min = today.toISOString().split('T')[0];
            // è®¾ç½®æœ€å¤§å€¼ä¸ºåå¤©
            dateInput.max = dayAfterTomorrow.toISOString().split('T')[0];
            // è®¾ç½®é»˜è®¤å€¼ä¸ºä»Šå¤©
            dateInput.value = today.toISOString().split('T')[0];
        }

        // åŒå‘è·¯çº¿éªŒè¯
        function validateAndGenerate() {
            const startStation = document.getElementById('start').value;
            const endStation = document.getElementById('end').value;
            const shiftSelect = document.getElementById('shift');
            const shiftValue = shiftSelect.value;
            const playerName = document.getElementById('playerName').value;
            const departureDate = document.getElementById('departureDate').value;
            
            // éªŒè¯èµ·ç‚¹ç»ˆç‚¹
            if (startStation === endStation) {
                document.getElementById('form-error-msg').textContent = 'èµ·ç‚¹å’Œç»ˆç‚¹ä¸èƒ½ç›¸åŒï¼Œè¯·é‡æ–°é€‰æ‹©ï¼';
                document.getElementById('form-error-msg').setAttribute('class', 'text-red-500');
                return;
            }
            
            // éªŒè¯æ—¥æœŸ
            if (!departureDate) {
                document.getElementById('form-error-msg').textContent = 'è¯·é€‰æ‹©å‡ºå‘æ—¥æœŸï¼';
                document.getElementById('form-error-msg').setAttribute('class', 'text-red-500');
                return;
            }
            
            // éªŒè¯ç­æ¬¡é€‰æ‹©
            if (!shiftValue) {
                document.getElementById('form-error-msg').textContent = 'è¯·é€‰æ‹©ç­æ¬¡ï¼';
                document.getElementById('form-error-msg').setAttribute('class', 'text-red-500');
                return;
            }
            
            // éªŒè¯ç©å®¶åç§°
            if (!playerName.trim()) {
                document.getElementById('form-error-msg').textContent = 'è¯·è¾“å…¥æ¸¸æˆåç§°ï¼';
                document.getElementById('form-error-msg').setAttribute('class', 'text-red-500');
                return;
            }
            
            // éªŒè¯æ‰€é€‰ç­æ¬¡æ˜¯å¦æœ‰æ•ˆ
            const [selectedShift, selectedTime] = shiftValue.split('|');
            const availableShifts = getAvailableShifts(startStation, endStation, departureDate);
            const isValidShift = availableShifts.some(shift => shift.shift === selectedShift && shift.time === selectedTime);
            
            if (!isValidShift) {
                document.getElementById('form-error-msg').textContent = 'æ‰€é€‰ç­æ¬¡ä¸ç¬¦åˆå½“å‰è·¯çº¿æˆ–æ—¶é—´ï¼Œè¯·é‡æ–°é€‰æ‹©ï¼';
                document.getElementById('form-error-msg').setAttribute('class', 'text-red-500');
                return;
            }
            
            // é˜²æ­¢å¤šæ¬¡ç‚¹å‡»
            const generateBtn = document.querySelector('button[onclick="validateAndGenerate()"]');
            if (generateBtn.disabled) {
                return; // å¦‚æœæŒ‰é’®å·²è¢«ç¦ç”¨ï¼Œç›´æ¥è¿”å›
            }
            
            generateTicket();
        }

        // ç”ŸæˆTIDï¼šä½¿ç”¨SRDç®—æ³•å¤„ç†èµ·å§‹ç«™å’Œç»ˆç‚¹ç«™æƒé‡
        function generateTID(startStation, endStation) {
            const startWeight = stationWeights[startStation];
            const endWeight = stationWeights[endStation];
            const weightStr = `${startWeight}${endWeight}`;
            return generateSRD(weightStr);
        }

        // ç”ŸæˆPIDï¼šä½¿ç”¨CSRDLCç®—æ³•å¤„ç†ç”¨æˆ·åå’Œæ—¥æœŸ
        function generatePID(playerName) {
            const now = new Date();
            const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
            return generateCSRDLC(`${playerName}${dateStr}`);
        }

        function generateTicket() {
            // è·å–æŒ‰é’®å¹¶ç¦ç”¨ï¼Œé˜²æ­¢å¤šæ¬¡ç‚¹å‡»
            const generateBtn = document.querySelector('button[onclick="validateAndGenerate()"]');
            const originalText = generateBtn.innerHTML;
            
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> ç”Ÿæˆä¸­...';
            generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            
            // æ¸…ç©ºä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
            document.getElementById('form-error-msg').textContent = 'æ­£åœ¨ç”Ÿæˆè½¦ç¥¨ï¼Œè¯·ç¨å€™...';
            document.getElementById('form-error-msg').setAttribute('class', 'text-yellow-500');
            
            const startStation = document.getElementById('start').value;
            const endStation = document.getElementById('end').value;
            const playerName = document.getElementById('playerName').value || 'æœªå‘½åç©å®¶';
            const shiftSelect = document.getElementById('shift');
            const shiftValue = shiftSelect.value;
            const departureDate = document.getElementById('departureDate').value;
            
            const [shiftCode, departureTime] = shiftValue.split('|');
            
            const ticketEl = document.getElementById('ticket');
            const bgImg = ticketEl.querySelector('.bg-img');
            const ticketNumberEl = document.getElementById('ticketNumber');
            const passengerIdEl = document.getElementById('passengerId');
            const routeEl = document.getElementById('route');
            const timeEl = document.getElementById('time');
            const playerNameDisplayEl = document.getElementById('playerNameDisplay');
            const shiftDisplayEl = document.getElementById('shiftDisplay');
            const priceDisplayEl = document.getElementById('priceDisplay');

            ticketEl.classList.add('hidden');
            ticketEl.classList.remove('block');
            
            // è®¡ç®—ç¥¨ä»·ï¼ˆæ ¹æ®è·ç¦»æƒé‡ï¼‰
            const distance = Math.abs(stationWeights[startStation] - stationWeights[endStation]);
            const price = ((distance+2) * 1.0 / 20).toFixed(2);
            priceDisplayEl.textContent = `${price} ç»¿å®çŸ³`;

            // ç”ŸæˆTIDå’ŒPID
            const tid = generateTID(startStation, endStation);
            const pid = generatePID(playerName);
            
            ticketNumberEl.textContent = `TID: ${tid}`;
            passengerIdEl.textContent = `PID: ${pid}`;
            
            // è®¾ç½®èƒŒæ™¯å›¾
            bgImg.src = `${startStation}.png`;

            // è®¾ç½®è·¯çº¿ä¿¡æ¯
            routeEl.dataset.start = startStation;
            routeEl.dataset.end = endStation;

            // ç”Ÿæˆè½¦ç¥¨æ—¶é—´æˆ³ï¼ˆæ˜¾ç¤ºå‡ºå‘æ—¶é—´ï¼‰
            const dateObj = new Date(departureDate);
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            const formatTime = `${year}å¹´${month}æœˆ${day}æ—¥ ${departureTime} å¼€`;
            timeEl.textContent = formatTime;

            // è®¾ç½®ç©å®¶åç§°å’Œç­æ¬¡
            playerNameDisplayEl.textContent = playerName;
            shiftDisplayEl.textContent = `${shiftCode} (${departureTime})`;

            // å­˜å‚¨å†å²è®°å½•
            const history = JSON.parse(localStorage.getItem('ticketHistory')) || [];
            history.push({
                start: startStation,
                end: endStation,
                playerName: playerName,
                shift: shiftCode,
                departureTime: departureTime,
                departureDate: departureDate,
                price: price,
                time: formatTime,
                tid: tid,
                pid: pid
            });
            localStorage.setItem('ticketHistory', JSON.stringify(history));
            document.getElementById('form-error-msg').textContent = `è½¦ç¥¨ç”ŸæˆæˆåŠŸï¼`;
            document.getElementById('form-error-msg').setAttribute('class', 'text-green-500');

            // æ˜¾ç¤ºå†å²è®°å½•
            updateHistoryTable();

            ticketEl.classList.remove('hidden');
            ticketEl.classList.add('block');
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            generateBtn.disabled = false;
            generateBtn.innerHTML = originalText;
            generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        // ç”Ÿæˆéšæœºè‹±æ–‡ç©å®¶å
        function generateRandomPlayerName() {
            const length = Math.floor(Math.random() * 5) + 3; // 3-7ä¸ªå­—ç¬¦
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        // éšæœºç”ŸæˆåŠŸèƒ½
        function generateRandomTicket() {
            const stations = Object.keys(stationWeights);
            let startStation, endStation;
            do {
                startStation = stations[Math.floor(Math.random() * stations.length)];
                endStation = stations[Math.floor(Math.random() * stations.length)];
            } while (startStation === endStation);

            document.getElementById('start').value = startStation;
            document.getElementById('end').value = endStation;

            // éšæœºé€‰æ‹©æ—¥æœŸï¼ˆä»Šå¤©ã€æ˜å¤©æˆ–åå¤©ï¼‰
            const today = new Date();
            const randomDay = Math.floor(Math.random() * 3); // 0: ä»Šå¤©, 1: æ˜å¤©, 2: åå¤©
            const selectedDate = new Date(today);
            selectedDate.setDate(today.getDate() + randomDay);
            document.getElementById('departureDate').value = selectedDate.toISOString().split('T')[0];

            updatePricePreview();
            updateStationInfo();
            updateShiftOptions();
            
            // è·å–å¯ç”¨ç­æ¬¡å¹¶éšæœºé€‰æ‹©ä¸€ä¸ª
            const availableShifts = getAvailableShifts(startStation, endStation, selectedDate.toISOString().split('T')[0]);
            if (availableShifts.length > 0) {
                const randomShift = availableShifts[Math.floor(Math.random() * availableShifts.length)];
                document.getElementById('shift').value = `${randomShift.shift}|${randomShift.time}`;
            }
            
            const randomName = generateRandomPlayerName();
            document.getElementById('playerName').value = randomName;
            
            // å»¶è¿Ÿç”Ÿæˆè½¦ç¥¨ï¼Œç¡®ä¿UIæ›´æ–°å®Œæˆ
            setTimeout(() => {
                if (availableShifts.length > 0) {
                    generateTicket();
                } else {
                    document.getElementById('form-error-msg').textContent = 'éšæœºç”Ÿæˆçš„è·¯çº¿æ²¡æœ‰å¯ç”¨ç­æ¬¡ï¼Œè¯·æ‰‹åŠ¨è°ƒæ•´';
                    document.getElementById('form-error-msg').setAttribute('class', 'text-red-500');
                }
            }, 100);
        }

        function viewHistory(index) {
            const history = JSON.parse(localStorage.getItem('ticketHistory')) || [];
            if (history.length <= index) return;
            
            const record = history[index];
            const ticketEl = document.getElementById('ticket');
            const bgImg = ticketEl.querySelector('.bg-img');
            const ticketNumberEl = document.getElementById('ticketNumber');
            const passengerIdEl = document.getElementById('passengerId');
            const routeEl = document.getElementById('route');
            const timeEl = document.getElementById('time');
            const playerNameDisplayEl = document.getElementById('playerNameDisplay');
            const shiftDisplayEl = document.getElementById('shiftDisplay');
            const priceDisplayEl = document.getElementById('priceDisplay');

            ticketEl.classList.remove('hidden');
            ticketEl.classList.add('block');
            
            // è®¾ç½®èƒŒæ™¯å›¾
            bgImg.src = `${record.start}.png`;

            // è®¾ç½®è·¯çº¿ä¿¡æ¯
            routeEl.dataset.start = record.start;
            routeEl.dataset.end = record.end;

            // è®¾ç½®IDä¿¡æ¯
            ticketNumberEl.textContent = `TID: ${record.tid}`;
            passengerIdEl.textContent = `PID: ${record.pid}`;
            
            // è®¾ç½®æ—¶é—´
            timeEl.textContent = record.time;

            // è®¾ç½®ç©å®¶åç§°å’Œç­æ¬¡
            playerNameDisplayEl.textContent = record.playerName;
            shiftDisplayEl.textContent = `${record.shift} (${record.departureTime || 'æœªè®°å½•æ—¶é—´'})`;
            
            // è®¾ç½®ä»·æ ¼
            priceDisplayEl.textContent = `${record.price} ç»¿å®çŸ³`;
        }

        function updateHistoryTable() {
            const history = JSON.parse(localStorage.getItem('ticketHistory')) || [];
            const historyBody = document.getElementById('historyBody');
            historyBody.innerHTML = '';
            
            if (history.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = '<td colspan="8" class="px-4 py-6 text-center text-gray-500">æš‚æ— å†å²è®°å½•</td>';
                historyBody.appendChild(emptyRow);
            } else {
                // æŒ‰æ—¶é—´å€’åºæ’åˆ—
                history.slice().reverse().forEach((record, index) => {
                    const reversedIndex = history.length - 1 - index;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3">${record.start}</td>
                        <td class="px-4 py-3">${record.end}</td>
                        <td class="px-4 py-3">${record.playerName}</td>
                        <td class="px-4 py-3">${record.shift}</td>
                        <td class="px-4 py-3">${record.departureTime || 'æœªè®°å½•'}</td>
                        <td class="px-4 py-3">${record.price} ç»¿å®çŸ³</td>
                        <td class="px-4 py-3">${record.time}</td>
                        <td class="px-4 py-3">
                            <button class="btn-hover text-white bg-blue-500 px-1 py-1 rounded-lg text-sm" onclick="viewHistory(${reversedIndex})">
                                æŸ¥çœ‹
                            </button>
                        </td>
                    `;
                    historyBody.appendChild(row);
                });
            }
        }

        // åˆå§‹åŒ–
        initDatePicker();
        updatePricePreview();
        updateStationInfo();
        updateShiftOptions();
        updateHistoryTable();
        
        // æ·»åŠ äº‹ä»¶ç›‘å¬
        document.getElementById('start').addEventListener('change', function() {
            updatePricePreview();
            updateStationInfo();
            updateShiftOptions();
        });
        
        document.getElementById('end').addEventListener('change', function() {
            updatePricePreview();
            updateStationInfo();
            updateShiftOptions();
        });
        
        document.getElementById('departureDate').addEventListener('change', function() {
            updateShiftOptions();
        });
    </script>
</body>
</html>
